name: Smoke Test - Governance
on:
  deployment_status:

permissions:
  contents: read
  deployments: read
  statuses: write
  id-token: write

jobs:
  test:
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success' && contains(github.event.deployment_status.target_url, 'governancemento')
    uses: mento-protocol/mento-automation-tests/.github/workflows/governance-smoke-test.yml@main
    with:
      CUSTOM_URL: ${{ github.event.deployment_status.environment_url }}
      IS_MAINNET: "false"
    secrets: inherit

  report-status:
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success' && contains(github.event.deployment_status.target_url, 'governancemento')
    steps:
      - name: Report Status to Commit
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.deployment.sha;
            const state = '${{ needs.test.result }}' === 'success' ? 'success' : 'failure';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

            await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                state: state,
                target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: state === 'success' ? 'Smoke tests passed' : 'Smoke tests failed',
                context: `smoke-test/governance/${timestamp}`
            });

            core.info(`Created commit status: smoke-test/governance/${timestamp}`);
